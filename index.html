<html>
	<head>
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>
	<body bgcolor="#444444">
		<button id="submitFreeInput">Map</button>
		<button id="Vor">Vor</button>
		<button id="VorStep">VorStep</button>
		<button id="VorFast">VorFast</button>
		<button id="Cut">Cut</button>
		<button id="CutStep">CutStep</button>
		<button id="CutFast">CutFast</button>
		<br>
		<canvas id="myCanvas" style="border:1px solid #000000;"></canvas>
		<canvas id="myCanvas2" style="border:1px solid #000000;"></canvas>
		<br>
		<textarea id="freeInput" rows="20" cols="100">{
	        "vertices": "2650.93,1656.09,-684.9;2653.73,1656.03,-684.59;2657.72,1656.44,-684.04;2663.32,1657.42,-683.27;2664.83,1659.24,-683.06;2664.53,1660.44,-683.09;2661.26,1662.2,-683.53;2658.14,1664.1,-683.94;2659.07,1667.14,-683.0;2660.93,1670.49,-682.31;2661.39,1672.89,-682.41;2661.89,1675.23,-682.19;2663.35,1677.29,-682.25;2663.78,1678.97,-682.47;2664.17,1680.6,-682.38;2664.84,1681.83,-682.3;2665.55,1684.88,-682.3;2667.11,1686.87,-682.36;2667.99,1688.24,-682.11;2669.38,1692.02,-681.71;2670.74,1693.48,-681.64;2671.5,1694.59,-681.58;2672.44,1696.87,-680.67;2673.07,1697.6,-680.45;2674.84,1697.67,-680.0;2687.323538461538,1658.5121538461538,-680.0;2684.99,1658.33,-680.32;2681.38,1658.45,-680.81;2678.02,1658.1,-681.27;2675.94,1658.29,-681.55;2674.27,1660.45,-681.77;2672.29,1660.89,-682.03;2671.15,1661.96,-682.18;2669.76,1662.89,-682.37;2667.63,1665.05,-682.45;2667.06,1665.97,-682.46;2666.62,1667.75,-682.46;2666.44,1669.72,-682.46;2667.24,1672.11,-682.1;2668.53,1674.96,-682.11;2669.39,1676.05,-682.12;2670.5,1677.41,-682.12;2671.18,1678.56,-682.12;2673.89,1681.44,-682.09;2674.72,1682.78,-682.08;2676.79,1685.18,-682.05;2676.69,1686.57,-682.05;2678.31,1688.9,-681.97;2678.69,1690.3,-681.9;2679.61,1692.16,-680.9;2680.67,1695.52,-680.8;2679.61,1696.15,-680.54;2678.39,1696.72,-680.42;2677.539879518072,1697.3930120481928,-680.0;2669.014,1683.897,-682.946;2668.11,1684.8,-682.98;2600.0,1656.2131764705882,-692.5841176470587;2603.02,1656.0,-692.14;2606.26,1656.45,-691.65;2609.33,1656.56,-691.19;2612.41,1656.5,-690.73;2616.35,1656.54,-690.14;2619.99,1656.48,-689.6;2623.6,1656.74,-689.06;2627.69,1656.47,-688.45;2631.23,1657.33,-687.92;2635.27,1656.57,-687.32;2639.44,1656.53,-686.7;2643.61,1656.32,-686.08;2647.5,1655.97,-685.49;2650.96,1656.16,-684.98;2650.0,1648.41,-685.13;2650.98,1649.55,-684.98;2650.35,1650.37,-685.07;2649.74,1650.55,-685.16;2646.18,1650.64,-685.7;2642.92,1650.73,-686.18;2639.46,1650.81,-686.7;2635.95,1650.8,-687.22;2632.7,1650.81,-687.71;2628.66,1650.78,-688.31;2625.3,1650.61,-688.81;2622.15,1650.6,-689.28;2619.35,1650.45,-689.7;2616.12,1650.49,-690.18;2613.04,1650.47,-690.64;2610.35,1650.48,-691.05;2606.71,1650.29,-691.59;2603.43,1650.1,-692.08;2600.65,1649.76,-692.49;2600.0,1649.720606060606,-692.5884848484849;2687.59,1652.46,-680.0;2684.35,1652.44,-680.44;2680.87,1652.55,-680.91;2676.11,1651.96,-681.56;2672.88,1652.04,-682.0;2664.46,1651.54,-683.15;2661.05,1650.87,-684.9;2658.28,1650.32,-684.9;2657.46,1649.96,-684.9;2656.11,1648.11,-684.9;2656.14,1645.26,-684.9;2655.41,1641.56,-684.9;2653.45,1641.46,-684.9;2669.37,1684.96,-683.59;2670.755819,1684.385975,-683.59;2670.87,1684.96,-683.59;2670.755819,1685.534025,-683.59;2670.43066,1686.02066,-683.59;2669.944025,1686.345819,-683.59;2669.37,1686.46,-683.59;2668.795975,1686.345819,-683.59;2668.30934,1686.02066,-683.59;2667.984181,1685.534025,-683.59;2667.87,1684.96,-683.59;2667.984181,1684.385975,-683.59;2668.30934,1683.89934,-683.59;2668.795975,1683.574181,-683.59;2669.37,1683.46,-683.59;2669.944025,1683.574181,-683.59;2670.43066,1683.89934,-683.59;2741.77,1766.73,-685.0;2743.715287,1766.043299,-685.0;2743.83,1766.84,-685.0;2743.631097,1767.619955,-685.0;2743.148858,1768.264422,-685.0;2742.456701,1768.675287,-685.0;2741.66,1768.79,-685.0;2740.880045,1768.591097,-685.0;2740.235578,1768.108858,-685.0;2739.824713,1767.416701,-685.0;2739.71,1766.62,-685.0;2739.908903,1765.840045,-685.0;2740.391142,1765.195578,-685.0;2741.083299,1764.784713,-685.0;2741.88,1764.67,-685.0;2742.659955,1764.868903,-685.0;2743.304422,1765.351142,-685.0;2749.96,1754.07,-684.7;2750.052388,1754.031732,-684.7;2750.06,1754.07,-684.7;2750.052388,1754.108268,-684.7;2750.030711,1754.140711,-684.7;2749.998268,1754.162388,-684.7;2749.96,1754.17,-684.7;2749.921732,1754.162388,-684.7;2749.889289,1754.140711,-684.7;2749.867612,1754.108268,-684.7;2749.86,1754.07,-684.7;2749.867612,1754.031732,-684.7;2749.889289,1753.999289,-684.7;2749.921732,1753.977612,-684.7;2749.96,1753.97,-684.7;2749.998268,1753.977612,-684.7;2750.030711,1753.999289,-684.7;2750.66,1756.3,-684.7;2750.752388,1756.261732,-684.7;2750.76,1756.3,-684.7;2750.752388,1756.338268,-684.7;2750.730711,1756.370711,-684.7;2750.698268,1756.392388,-684.7;2750.66,1756.4,-684.7;2750.621732,1756.392388,-684.7;2750.589289,1756.370711,-684.7;2750.567612,1756.338268,-684.7;2750.56,1756.3,-684.7;2750.567612,1756.261732,-684.7;2750.589289,1756.229289,-684.7;2750.621732,1756.207612,-684.7;2750.66,1756.2,-684.7;2750.698268,1756.207612,-684.7;2750.730711,1756.229289,-684.7;2722.846891,1627.624715,-684.287098;2723.03,1629.61,-684.21;2721.96,1631.72,-684.22;2721.96,1637.28,-684.25;2722.51,1643.71,-684.29;2723.93,1650.88,-684.32;2725.36,1655.85,-684.34;2726.51,1659.92,-684.36;2728.41,1665.77,-684.38;2729.54,1670.09,-684.39;2730.66,1674.85,-684.41;2732.39,1679.96,-684.43;2733.91,1686.02,-684.45;2735.22,1690.22,-684.47;2736.4,1693.83,-684.48;2737.64,1699.27,-684.5;2738.92,1703.65,-684.52;2739.64,1706.93,-684.53;2740.47,1709.98,-684.55;2741.6,1711.28,-684.55;2744.5,1711.63,-684.55;2744.28,1714.6,-684.57;2744.59,1719.58,-684.58;2745.87,1722.69,-684.6;2744.87,1725.53,-684.6;2745.03,1728.86,-684.62;2746.21,1732.85,-684.63;2747.69,1736.92,-684.65;2749.12,1742.67,-684.67;2750.27,1746.46,-684.68;2752.64,1750.56,-684.7;2755.52,1754.62,-684.68;2758.39,1759.41,-684.66;2759.78,1761.14,-684.65;2762.21,1764.96,-684.64;2766.38,1769.02,-684.62;2772.25,1775.45,-684.6;2778.78,1781.47,-684.62;2781.33,1784.46,-684.62;2786.21,1789.15,-684.64;2792.29,1794.9,-684.65;2797.785848375451,1800.0,-684.6684115523466;2739.71,1766.79,-685.0;2738.39,1766.61,-684.7;2739.44,1764.0,-684.7;2739.39,1758.51,-684.7;2739.17,1750.46,-684.69;2739.27,1745.12,-684.67;2738.68,1740.32,-684.65;2738.17,1736.48,-684.64;2740.38,1735.19,-684.63;2741.52,1731.1,-684.62;2741.23,1727.44,-684.61;2740.46,1724.09,-684.59;2739.16,1719.25,-684.58;2737.88,1714.19,-684.56;2736.45,1709.92,-684.54;2735.51,1705.67,-684.53;2734.33,1701.52,-684.51;2732.42,1695.39,-684.49;2731.47,1692.13,-684.47;2729.95,1686.82,-684.45;2729.32,1684.02,-684.44;2728.58,1680.0,-684.43;2725.6,1670.38,-684.39;2724.4,1665.55,-684.37;2724.15,1664.02,-684.37;2720.0,1665.3,-684.37;2717.83,1661.79,-684.35;2722.24,1659.85,-684.35;2720.4,1656.64,-684.34;2718.95,1650.91,-684.32;2717.44,1647.2,-684.3;2714.74,1642.49,-684.27;2712.06,1639.68,-684.25;2711.43,1637.72,-684.24;2710.28,1635.43,-684.22;2706.73,1632.52,-684.24;2705.57,1631.11,-684.23;2704.15,1630.22,-684.23;2701.36,1628.4,-684.21;2697.48,1626.35,-684.19;2695.81,1624.87,-684.18;2693.63,1623.57,-684.17;2689.4,1622.0,-684.14;2687.89,1624.43,-683.94;2686.61,1626.71,-683.9;2684.37,1625.74,-683.9;2684.41,1624.04,-683.9;2685.82,1620.64,-683.99;2672.12,1607.84,-682.34;2669.55,1609.69,-684.02;2669.88,1611.4,-684.03;2671.07,1612.16,-684.03;2673.63,1612.68,-684.05;2675.31,1612.87,-684.06;2678.58,1613.26,-684.07;2682.92,1614.73,-684.1;2686.45,1614.95,-684.12;2689.63,1615.98,-684.13;2692.82,1617.97,-684.15;2695.73,1619.69,-684.17;2697.61,1620.84,-684.18;2699.61,1621.81,-684.2;2704.12,1625.26,-684.21;2705.74,1626.31,-684.22;2707.94,1628.35,-684.23;2711.18,1631.37,-684.2;2713.49,1632.24,-684.21;2714.61,1631.61,-684.21;2714.59,1630.08,-684.2;2713.674087,1626.797977,-684.179184;2743.24,1765.28,-685.0;2743.68,1764.68,-684.7;2743.79,1763.16,-684.7;2745.07,1762.35,-684.7;2745.97,1759.23,-684.7;2746.36,1757.45,-684.7;2746.22,1758.05,-684.7;2745.12,1756.63,-684.7;2746.54,1751.65,-684.7;2746.24,1750.59,-684.7;2746.15,1747.59,-684.7;2747.11,1747.29,-684.7;2748.2,1749.17,-684.7;2749.43,1752.63,-684.7;2749.43,1752.6,-684.7;2750.03,1753.32,-684.7;2792.981487179487,1800.0,-684.6605641025641;2790.8,1797.94,-684.65;2787.69,1795.03,-684.65;2783.39,1791.07,-684.64;2778.05,1785.54,-684.62;2773.26,1781.65,-684.61;2771.77,1780.22,-684.6;2769.86,1780.14,-684.6;2767.79,1778.0,-684.6;2765.04,1773.49,-684.61;2763.6,1771.77,-682.7;2761.59,1770.11,-682.7;2761.27,1768.82,-684.63;2759.53,1766.98,-684.64;2757.15,1763.75,-684.65;2751.21,1757.16,-685.01;2754.04,1757.98,-684.67;2756.19,1760.87,-684.66;2757.23,1763.83,-684.65;2638.91,1641.62,-687.2;2635.17,1639.56,-682.8;2632.68,1638.99,-682.73;2629.41,1638.62,-682.63;2626.51,1638.02,-682.6;2625.68,1636.44,-682.6;2627.12,1633.07,-682.6;2630.28,1629.83,-684.0;2629.61,1626.01,-684.0;2633.1,1624.86,-683.88;2634.04,1624.1,-683.84;2637.5,1622.72,-683.72;2641.45,1621.34,-683.58;2643.94,1620.26,-683.49;2646.26,1619.48,-683.4;2648.17,1618.24,-683.33;2647.85,1617.12,-683.32;2646.3,1616.15,-683.35;2640.08,1615.61,-683.86;2637.99,1615.96,-683.85;2685.8,1620.63,-685.0;2684.53,1619.87,-684.11;2680.67,1619.17,-684.09;2678.79,1619.01,-684.08;2676.02,1618.38,-684.07;2674.01,1618.27,-684.06;2673.34,1620.89,-684.06;2670.32,1621.03,-684.04;2669.57,1618.2,-684.03;2665.53,1617.17,-682.8;2661.54,1617.23,-682.91;2659.27,1618.87,-683.0;2656.29,1620.97,-683.13;2652.42,1622.1,-683.26;2650.46,1623.21,-683.34;2649.27,1623.71,-683.38;2646.97,1625.15,-683.47;2645.34,1625.7,-683.53;2644.3,1626.79,-683.58;2641.6,1627.64,-683.67;2638.64,1629.38,-683.79;2636.25,1630.46,-683.88;2631.79,1632.71,-684.0;2629.81,1633.03,-682.6;2628.99,1634.24,-682.6;2630.05,1635.49,-682.61;2633.46,1635.92,-682.71;2639.0,1636.35,-682.87;2643.06,1636.51,-682.98;2645.15,1635.15,-683.02;2647.89,1635.42,-683.1;2648.28,1639.92,-683.16;2639.06,1610.63,-683.85;2642.56,1610.85,-683.87;2646.75,1611.02,-683.9;2650.54,1611.39,-683.92;2654.27,1611.46,-683.94;2656.46,1611.52,-683.98;2658.06,1610.63,-683.98;2659.09,1609.19,-683.98;2658.82,1607.08,-683.97;2657.31,1603.49,-683.96;2655.72,1600.84,-683.94;2655.348932038835,1600.0,-683.94;2661.44540533751,1600.0,-683.9456756043852;2662.12,1601.28,-683.95;2663.58,1604.05,-683.97;2666.07,1604.9,-683.97;2667.9,1604.37,-683.97;2669.84,1603.4,-683.19;2672.18,1607.8,-682.3;2674.57,1606.61,-682.3;2677.09,1605.89,-682.3;2669.84,1603.4,-683.18;2672.03,1602.31,-682.3;2675.11,1601.03,-682.3;2763.68,1771.7,-682.7;2761.61,1770.09,-682.7;2669.4,1683.500003,-683.40283;2669.4,1683.5000027846363,-700.0",
	        "faces": "0,1@0;1,2@0;2,3@0;3,4@0;4,5@0;5,6@0;6,7@0;7,8@0;8,9@0;9,10@0;10,11@0;11,12@0;12,13@0;13,14@0;14,15@0;15,16@0;16,17@0;17,18@0;18,19@0;19,20@0;20,21@0;21,22@0;22,23@0;23,24@0;25,26@0;26,27@0;27,28@0;28,29@0;29,30@0;30,31@0;31,32@0;32,33@0;33,34@0;34,35@0;35,36@0;36,37@0;37,38@0;38,39@0;39,40@0;40,41@0;41,42@0;42,43@0;43,44@0;44,45@0;45,46@0;46,47@0;47,48@0;48,49@0;49,50@0;50,51@0;51,52@0;52,53@0;56,57@0;57,58@0;58,59@0;59,60@0;60,61@0;61,62@0;62,63@0;63,64@0;64,65@0;65,66@0;66,67@0;67,68@0;68,69@0;69,70@0;71,72@0;72,73@0;73,74@0;74,75@0;75,76@0;76,77@0;77,78@0;78,79@0;79,80@0;80,81@0;81,82@0;82,83@0;83,84@0;84,85@0;85,86@0;86,87@0;87,88@0;88,89@0;89,90@0;91,92@0;92,93@0;93,94@0;94,95@0;95,96@0;96,97@0;97,98@0;98,99@0;99,100@0;100,101@0;101,102@0;102,103@0;104,105,106@0;104,106,107@0;104,107,108@0;104,108,109@0;104,109,110@0;104,110,111@0;104,111,112@0;104,112,113@0;104,113,114@0;104,114,115@0;104,115,116@0;104,116,117@0;104,117,118@0;104,118,119@0;104,119,120@0;104,120,105@0;121,122,123@0;121,123,124@0;121,124,125@0;121,125,126@0;121,126,127@0;121,127,128@0;121,128,129@0;121,129,130@0;121,130,131@0;121,131,132@0;121,132,133@0;121,133,134@0;121,134,135@0;121,135,136@0;121,136,137@0;121,137,122@0;138,139,140@0;138,140,141@0;138,141,142@0;138,142,143@0;138,143,144@0;138,144,145@0;138,145,146@0;138,146,147@0;138,147,148@0;138,148,149@0;138,149,150@0;138,150,151@0;138,151,152@0;138,152,153@0;138,153,154@0;138,154,139@0;155,156,157@0;155,157,158@0;155,158,159@0;155,159,160@0;155,160,161@0;155,161,162@0;155,162,163@0;155,163,164@0;155,164,165@0;155,165,166@0;155,166,167@0;155,167,168@0;155,168,169@0;155,169,170@0;155,170,171@0;155,171,156@0;172,173@0;173,174@0;174,175@0;175,176@0;176,177@0;177,178@0;178,179@0;179,180@0;180,181@0;181,182@0;182,183@0;183,184@0;184,185@0;185,186@0;186,187@0;187,188@0;188,189@0;189,190@0;190,191@0;191,192@0;192,193@0;193,194@0;194,195@0;195,196@0;196,197@0;197,198@0;198,199@0;199,200@0;200,201@0;201,202@0;202,203@0;203,204@0;204,205@0;205,206@0;206,207@0;207,208@0;208,209@0;209,210@0;210,211@0;211,212@0;212,213@0;214,215@0;215,216@0;216,217@0;217,218@0;218,219@0;219,220@0;220,221@0;221,222@0;222,223@0;223,224@0;224,225@0;225,226@0;226,227@0;227,228@0;228,229@0;229,230@0;230,231@0;231,232@0;232,233@0;233,234@0;234,235@0;235,236@0;236,237@0;237,238@0;238,239@0;239,240@0;240,241@0;241,242@0;242,243@0;243,244@0;244,245@0;245,246@0;246,247@0;247,248@0;248,249@0;249,250@0;250,251@0;251,252@0;252,253@0;253,254@0;254,255@0;255,256@0;256,257@0;257,258@0;258,259@0;259,260@0;260,261@0;262,263@0;263,264@0;264,265@0;265,266@0;266,267@0;267,268@0;268,269@0;269,270@0;270,271@0;271,272@0;272,273@0;273,274@0;274,275@0;275,276@0;276,277@0;277,278@0;278,279@0;279,280@0;280,281@0;281,282@0;282,283@0;284,285@0;285,286@0;286,287@0;287,288@0;288,289@0;290,291@0;291,292@0;293,294@0;294,295@0;295,296@0;296,297@0;298,299@0;300,301@0;301,302@0;302,303@0;303,304@0;304,305@0;305,306@0;306,307@0;307,308@0;308,309@0;309,310@0;311,312@0;312,313@0;313,314@0;315,316@0;316,317@0;317,318@0;319,320@0;320,321@0;321,322@0;322,323@0;323,324@0;324,325@0;325,326@0;326,327@0;327,328@0;328,329@0;329,330@0;330,331@0;331,332@0;332,333@0;333,334@0;334,335@0;335,336@0;336,337@0;337,338@0;339,340@0;340,341@0;341,342@0;342,343@0;343,344@0;344,345@0;345,346@0;346,347@0;347,348@0;348,349@0;349,350@0;350,351@0;351,352@0;352,353@0;353,354@0;354,355@0;355,356@0;356,357@0;357,358@0;358,359@0;359,360@0;360,361@0;361,362@0;362,363@0;363,364@0;364,365@0;365,366@0;366,367@0;367,368@0;368,369@0;369,370@0;371,372@0;372,373@0;373,374@0;374,375@0;375,376@0;376,377@0;377,378@0;378,379@0;379,380@0;380,381@0;381,382@0;383,384@0;384,385@0;385,386@0;386,387@0;387,388@0;389,390@0;390,391@0;392,393@0;393,394@0;395,396@0",
	        "boundingBox": {
	            "min": [
	            2600,
	            1600,
	            -700
	           ],
	           "max": [
	            2800,
	            1800,
	            -680
	           ]
	         }
    	}</textarea>
	</body>

	<!--script src="js-priority-queue/priority-queue.js"></script>

	<script type="module" src="voronoi.mjs"></script>
	<script type="module" src="lineIntersect.mjs"></script-->

	<script type="module">
 		//54,55@0;;397,398@0
		//import { PriorityQueue }  from "./js-priority-queue/priority-queue.js"
		//import * as pq  from "./js-priority-queue/priority-queue.min.js";
		import "./js-priority-queue/priority-queue.min.js";

		//import pq from "./js-priority-queue/priority-queue.js";
		//const { PriorityQueue } = pq;
		import {voronoi} from "./voronoi/voronoi.mjs";
		import {Site} from "./voronoi/site.mjs";
		import {Vertex} from "./voronoi/vertex.mjs";
		import {Edge} from "./voronoi/edge.mjs";
		import {lineIntersect} from "./lineIntersect.mjs";

		const canvasWidth = 1000;
		const canvasHeight = 1000;
		const $canvas = $("#myCanvas");
		const $canvas2 = $("#myCanvas2");
		const canvas = $canvas[0];
		const canvas2 = $canvas2[0];

		// $canvas.width(canvasWidth).height(canvasHeight);
		// $canvas2.width(canvasWidth).height(canvasHeight);

		canvas.width = canvasWidth;
		canvas.height = canvasHeight;
		canvas2.width = canvasWidth*2;
		canvas2.height = canvasHeight*2;

		const c1 = canvas.getContext("2d");
		const c2 = canvas2.getContext("2d");

		function clearCanvas(context) //Over vor lin
		{
			context.fillStyle = "#ffffff";
			context.fillRect(0, 0, context.canvas.clientWidth, context.canvas.clientHeight);
		}


		var lines = []; //Over

		var dotSize = 3; // Vor, Lin, Over


		clearCanvas(c1); //Over
		clearCanvas(c2); //Over


		 function compareEvents(a, b) //Over vor Lin
		 {
			if(a.y === b.y ) return a.x - b.x
			return a.y - b.y;
		}

		function makeMapper(a, b, c, d) //None
		{
			if(a == b)
			throw "Zero distance map between " + a + " and " + b
			return function(x)
			{
				let res = (x-a)/(b-a) * (d-c) + c
				//	if(isNaN(res))
				//	console.log("%f mapped to %f (%s)", x, res, res);
				return res;
			}
		}

		function makeCoordCorrecter(coef, buff, offset) //Lin, Vor, Over
		{
			return function(coord)
			{
				return (coord-offset) * coef + buff;
			}
		}

		function properSites() //Over
		{
			let vertFaces = getVertsFaces();
			let sites = [];
			let verts = vertFaces[0];
			for(let face of vertFaces[1])
			{
				if(face.length == 2)
				{
					let x1 = parseFloat(verts[face[0]][0]);
					let y1 = parseFloat(verts[face[0]][1]);
					let x2 = parseFloat(verts[face[1]][0]);
					let y2 = parseFloat(verts[face[1]][1]);
					sites.push(new Site(x1, y1));
					sites.push(new Site(x2, y2));
				}
			}

			var queue = new PriorityQueue({ initialValues: sites, comparator: compareEvents });
			let cleanSites = [];
			let lastSite = queue.dequeue();
			while(queue.length > 0)
			{
				let site = queue.dequeue();
				if(site.y == lastSite.y && site.x == lastSite.x)
				{
					//discard
				}
				else
				{
					cleanSites.push(site);
					lastSite = site;
				}
			}
			return cleanSites;
		}

		function getMinMax() //Over
		{
			let json;
			try{
				json = JSON.parse($("#freeInput").val());
			}
			catch (e) {
				if (e instanceof SyntaxError) {
					alert("Invalid json");
					console.error(e);
				} else {
					alert(e);
				}
				return;
			}
			var minX = json.boundingBox.min[0];
			var minY = json.boundingBox.min[1];
			var maxX = json.boundingBox.max[0];
			var maxY = json.boundingBox.max[1];

			return [[minX, maxX], [minY, maxY]];
		}

		function realArguments(draw, step) //Over
		{
			let minmax = getMinMax();
			let minX = minmax[0][0];
			let maxX = minmax[0][1];
			let minY = minmax[1][0];
			let maxY = minmax[1][1];

			let sites = properSites();

			let heightCoef = (canvas.height / (maxY-minY)) * 0.95;
			let widthCoef = (canvas.width / (maxX-minX)) * 0.95;
			let heightBuff = canvas.height * 0.025;
			let widthBuff = canvas.width * 0.025;

			//heightCoef = (canvas.height / (maxY * 10)) * 0.95;
			//widthCoef = (canvas.width / (maxX * 10)) * 0.95;

			//return [[bigSites], [makeCoordCorrecter(widthCoef, widthBuff, 0), makeCoordCorrecter(heightCoef, heightBuff, 0), 0, maxY*10]];
			return [sites, draw, step, makeCoordCorrecter(widthCoef, widthBuff, minX), makeCoordCorrecter(heightCoef, heightBuff, minY), minY, maxY, c1, c2];
		}

		$("#Vor").click(function() //Over
		{
			voronoi.apply(this, realArguments(true, false));
		});
		$("#VorStep").click(function() //Over
		{
			let func = voronoi.apply(this, realArguments(false, true));
			$("#VorStep").off("click").click(func);

			for(let i = 0; i < 0; i++)
			{
				$("#VorStep").click();
			}
		});
		$("#VorFast").click(function() //Over
		{
			let minmax = getMinMax();
			let minX = minmax[0][0];
			let maxX = minmax[0][1];
			let minY = minmax[1][0];
			let maxY = minmax[1][1];

			let sites = properSites();

			let res = voronoi(sites, false, false, null, null, null, null, null, null, null);

			let heightCoef = (canvas.height / (maxY-minY)) * 0.95;
			let widthCoef = (canvas.width / (maxX-minX)) * 0.95;
			let heightBuff = canvas.height * 0.025;
			let widthBuff = canvas.width * 0.025;

			let yCorr = makeCoordCorrecter(heightCoef, heightBuff, minY);
			let xCorr = makeCoordCorrecter(widthCoef, widthBuff, minX);
			clearCanvas(c1);

			if(false)
			{
				c1.fillStyle = "#0000FF";
				for(let vert of res[0])
				{
					c1.beginPath();
					c1.arc(xCorr(vert.x), yCorr(vert.y), dotSize, 0, 2 * Math.PI, false);
					c1.fill();
				}
			}
			if(true)
			{
				for(let edge of res[1])
				{
					if(edge.twin.origin != null)
					{
						edge.draw(xCorr, yCorr, "#FF0000", c1);
					}
				}
			}
			overlayMap();
		});

		function realCuts(draw, step) //Over
		{
			let sites = properSites();
			let res = voronoi(sites, false, false, null, null, null, null, null, null, null);
			let map = getMapEdgeList();

			if(draw || step)
			{
				let minmax = getMinMax();
				let minX = minmax[0][0];
				let maxX = minmax[0][1];
				let minY = minmax[1][0];
				let maxY = minmax[1][1];


				let heightCoef = (canvas.height / (maxY-minY)) * 0.95;
				let widthCoef = (canvas.width / (maxX-minX)) * 0.95;
				let heightBuff = canvas.height * 0.025;
				let widthBuff = canvas.width * 0.025;

				let xCorr = makeCoordCorrecter(widthCoef, widthBuff, minX);
				let yCorr = makeCoordCorrecter(heightCoef, heightBuff, minY);
				return [[map[0], map[1]], res, draw, step, xCorr, yCorr, minY, maxY, c1, c2]
			}
			else return [[map[0], map[1]], res, draw, step, null, null, null, null, null, null]
		}

		$("#Cut").click(function() // Over
		{
			lineIntersect.apply(this, realCuts(true, false));
		});

		$("#CutStep").click(function() //Over
		{
			let res = lineIntersect.apply(this, realCuts(false, true));
			$("#CutStep").off("click").click(res);
		});
		$("#CutFast").click(function() //Over
		{
			let res = lineIntersect.apply(this, realCuts(false, false));

			let minmax = getMinMax();
			let minX = minmax[0][0];
			let maxX = minmax[0][1];
			let minY = minmax[1][0];
			let maxY = minmax[1][1];

			let heightCoef = (canvas.height / (maxY-minY)) * 0.95;
			let widthCoef = (canvas.width / (maxX-minX)) * 0.95;
			let heightBuff = canvas.height * 0.025;
			let widthBuff = canvas.width * 0.025;

			let yCorr = makeCoordCorrecter(heightCoef, heightBuff, minY);
			let xCorr = makeCoordCorrecter(widthCoef, widthBuff, minX);

			clearCanvas(c1);

			for(let edge of res[1])
			{
				edge.draw(xCorr, yCorr, "#ff0000", c1);
			}
			overlayMap();
		});


		function drawArrows(edge, xCorr, yCorr) //Over
		{

			let vX = edge.twin.origin.x - edge.origin.x;
			let vY = edge.twin.origin.y - edge.origin.y;

			let rX = -vY;
			let rY = vX;
			let mag = Math.sqrt(Math.pow(rX, 2) + Math.pow(rY, 2));
			rX = rX/mag;
			rY = rY/mag;

			let ndX = vX/mag;
			let ndY = vY/mag;

			let lX = -rX;
			let lY = -rY;

			let size = 100;
			rX = rX*size;
			rY = rY*size;
			lX = lX*size;
			lY = lY*size;
			ndX = ndX*size;
			ndY = ndY*size;

			let loX = edge.origin.x + lX/3;
			let loY = edge.origin.y + lY/3;
			let roX = edge.origin.x + rX/3;
			let roY = edge.origin.y + rY/3;

			let ltoX = edge.twin.origin.x +lX/3;
			let ltoY = edge.twin.origin.y +lY/3;
			let rtoX = edge.twin.origin.x +rX/3;
			let rtoY = edge.twin.origin.y +rY/3;


			c1.strokeStyle = "#FF0000";
			c1.beginPath();
			c1.moveTo(xCorr(loX), yCorr(loY));
			c1.lineTo(xCorr(ltoX), yCorr(ltoY));
			c1.stroke();

			c1.strokeStyle = "#FF0000";
			c1.beginPath();
			c1.moveTo(xCorr(roX), yCorr(roY));
			c1.lineTo(xCorr(rtoX), yCorr(rtoY));
			c1.stroke();

			c1.strokeStyle = "#b600ff"; //purple
			c1.beginPath();
			c1.moveTo(xCorr(roX), yCorr(roY));
			c1.lineTo(xCorr(roX + rX + ndX), yCorr(roY + rY + ndY));
			c1.stroke();

			c1.beginPath();
			c1.moveTo(xCorr(ltoX), yCorr(ltoY));
			c1.lineTo(xCorr(ltoX + lX - ndX), yCorr(ltoY + lY - ndY));
			c1.stroke();

		}


		function vertexEdge(startID, startEdge, endID, endEdge) //Over?
		{
			this.startID = startID;
			this.startEdge = startEdge;
			this.endID = endID;
			this.endEdge = endEdge;
		}

		function vertexLine(startEdge, endEdge, ID) //None??? Unused
		{
			this.startEdge = startEdge;
			this.endEdge = endEdge;

			this.numEdges = 1;
			this.ID = ID;
		}

		function mergeLines(first, second) //Over
		{
			if(first.startEdge.startID == second.endEdge.endID)
			{
				second.endEdge.endEdge = first.startEdge; 	//Connect ends
				first.startEdge.startEdge = second.endEdge;	//Connect ends
				first.startEdge = second.startEdge;			//Take over start
				first.numEdges += second.numEdges;
			}
			else if(first.endEdge.endID == second.startEdge.startID)
			{
				second.startEdge.startEdge = first.endEdge; //Connect ends
				first.endEdge.endEdge = second.startEdge;	//Connect ends
				first.endEdge = second.endEdge;				//Take over end
				first.numEdges += second.numEdges;
			}
			else if(first.startEdge.startID == second.startEdge.startID)
			{
				proc = second.startEdge;
				prev = first.startEdge
				while(proc != null)
				{
					ve = new vertexEdge(proc.endID, null, proc.startID, prev);
					prev.startEdge = ve;
					first.startEdge = ve;
					first.numEdges++;

					prev = ve;
					proc = proc.endEdge;
				}
			}
			else if(first.endEdge.endID == second.endEdge.endID)
			{
				proc = second.endEdge;
				prev = first.endEdge
				while(proc != null)
				{
					ve = new vertexEdge(proc.endID, prev, proc.startID, null);
					prev.endEdge = ve;
					first.endEdge = ve;
					first.numEdges++;

					prev = ve;
					proc = proc.startEdge;
				}
			}
			else {
				console.error("Error in merging!");
			}
		}

		function drawLines()//Over
		{

			clearCanvas(c2);


			cols = ["#ff9d00", "#fff200", "#83ff00", "#00ffd4", "#00b2ff", "#0400ff", "#ae00ff", "#ff00a1", "#000000", "#7a2e00", "#ffa5a5", "#7c7b61"];
			for(var i = 0; i < lines.length; i++)
			{
				c2.strokeStyle = cols[i%cols.length];
				proc = lines[i].startEdge
				while(proc != null)
				{
					v1x = vertices[proc.startID][0]- minX;
					v1y = vertices[proc.startID][1]- minY;
					v2x = vertices[proc.endID][0]- minX;
					v2y = vertices[proc.endID][1]- minY;


					c2.beginPath();
					c2.moveTo(v1x * widthCoef + widthBuff, v1y * heightCoef + heightBuff);
					c2.lineTo(v2x * widthCoef + widthBuff, v2y * heightCoef + heightBuff);
					c2.stroke();

					proc = proc.endEdge;
				}
			}
		}

		function getVertsFaces() //Over
		{
			let json;
			try{
				json = JSON.parse($("#freeInput").val());
			}
			catch (e) {
			    if (e instanceof SyntaxError) {
			        alert("Invalid json");
					console.error(e);
			    } else {
			        alert(e);
			    }
				return;
			}
			if((!json.boundingBox) || (!json.faces) || (!json.vertices))
			{
				console.error("Invalid mine map");
				return;
			}

			let dirtyFaces = json.faces.split(";");
			let cleanFaces = [];
			for(let df of dirtyFaces)
			{
				let cleanUnsplitSuffix = df.split("@");
				let strFace = cleanUnsplitSuffix[0].split(",");
				let intFace = [];
				for(let str of strFace)
					intFace.push(parseInt(str));
				cleanFaces.push(intFace);
			}
			let verticesGroup = json.vertices;
			verticesGroup = verticesGroup.split(";");
			let vertices = []
			for (let group of verticesGroup)
			{
				let strVert = group.split(",");
				let floatVert = []
				for (let str of strVert)
					floatVert.push(parseFloat(str));
				vertices.push(floatVert);
			}

			return [vertices, cleanFaces];
		}

		function overlayMap() //Over
		{
			let vertFaces = getVertsFaces();
			let minmax = getMinMax();
			let minX = minmax[0][0];
			let maxX = minmax[0][1];
			let minY = minmax[1][0];
			let maxY = minmax[1][1];

			let heightCoef = (canvas.height / (maxY-minY)) * 0.95;
			let widthCoef = (canvas.width / (maxX-minX)) * 0.95;
			let heightBuff = canvas.height * 0.025;
			let widthBuff = canvas.width * 0.025;

			let xCorr = makeCoordCorrecter(widthCoef, widthBuff, minX);
			let yCorr = makeCoordCorrecter(heightCoef, heightBuff, minY);

			let vertices = vertFaces[0];
			let faces = vertFaces[1];

			c1.strokeStyle = "#000000";
			c1.fillStyle = "#ffb33a";

			for(let face of faces)
			{
				if (face.length == 2)
				{
					let v1x = vertices[face[0]][0];
					let v1y = vertices[face[0]][1];
					let v2x = vertices[face[1]][0];
					let v2y = vertices[face[1]][1];

					c1.beginPath();
					c1.moveTo(xCorr(v1x), yCorr(v1y));
					c1.lineTo(xCorr(v2x), yCorr(v2y));
					c1.stroke();
				}
				else if (face.length == 3)
				{
					continue;
					let v1x = vertices[face[0]][0];
					let v1y = vertices[face[0]][1];
					let v2x = vertices[face[1]][0];
					let v2y = vertices[face[1]][1];
					let v3x = vertices[face[2]][0];
					let v3y = vertices[face[2]][1];


					c1.beginPath();
					c1.moveTo(xCorr(v1x), yCorr(v1y));
					c1.lineTo(xCorr(v2x), yCorr(v2y));
					c1.lineTo(xCorr(v3x), yCorr(v3y));
					c1.fill();
				}
			}
		}

		function getMapEdgeList() //Over
		{
			let vertFaces = getVertsFaces();
			let rawVerts = vertFaces[0];
			let faces = vertFaces[1];

			//Build up doubly connected edge list. Assume any vertice has at most two edges. (Forms a line, not a polygon or intersection)
			let vertices = [];
			let edges = [];
			for (let raw of rawVerts)
			{
				vertices.push(new Vertex(raw[0], raw[1]));
			}

			//Connecting edges to vertices.
			for (let face of faces)
			{
				if (face.length !== 2) {continue};

				let v1 = vertices[face[0]];
				let v2 = vertices[face[1]];

				let Ev1v2 = new Edge(v1, null);
				let Ev2v1 = new Edge(v2, Ev1v2);
				Ev1v2.twin = Ev2v1;
				edges.push(Ev1v2);
				if(v1.edge == null)
				{
					v1.edge = Ev1v2;
				}
				else
				{
					v1.edge.twin.next = Ev1v2;
					v1.edge.prev = Ev2v1;
					Ev2v1.next = v1.edge;
					Ev1v2.prev = v1.edge.twin;
				}
				if(v2.edge == null)
				{
					v2.edge = Ev2v1;
				}
				else
				{
					v2.edge.twin.next = Ev2v1;
					v2.edge.prev = Ev1v2;
					Ev1v2.next = v2.edge;
					Ev2v1.prev = v2.edge.twin;
				}

			}
			//Find disjoint sets
			let endings = [];
			let endingProcessed = [];
			let pairs = [];
			for (let vertex of vertices)
			{
				if((vertex.edge != null) && (vertex.edge.twin.next == null))
				{
					endings.push(vertex);
					endingProcessed.push(false);
				}
			}
			for(let i = 0; i < endings.length; i++)
			{
				if(endingProcessed[i]) continue;
				endingProcessed[i] = true;
				let ending = endings[i];
				let edge = ending.edge;
				while(edge.next != null)
					edge = edge.next;
				let otherEnd = edge.twin.origin;
				let found = false;
				for(let j = i+1; j < endings.length; j++)
				{
					if(endings[j] == otherEnd)
					{
						if(endingProcessed[j]) console.error("Other end already processed");
						endingProcessed[j] = true;
						found = true;
						break;
					}
				}
				if(!found) console.error("Other end not in endings!");
				pairs.push([ending, otherEnd]);
			}
			//Clear duplicate internal
			for(let pair of pairs)
			{
				let edge = pair[0].edge;
				while(edge != null)
				{
					if((edge.origin.x == edge.twin.origin.x) && (edge.origin.y == edge.twin.origin.y))
					{
						//console.log("Duplicate internal");
						let before = edge.prev;
						let after = edge.next;
						before.next = after;
						after.prev = before;
						before.twin.prev = after.twin;
						after.twin.next = before.twin;
						before.twin.origin = after.origin; //disregard edge.origin
						edge.origin.edge = null;
						edge.origin = null;
						edge.twin.origin = null;
					}
					edge = edge.next;
				}
			}
			//Verify chain
			for(let pair of pairs)
			{
				for(let comb of [[0,1],[1,0]])
				{
					let start = pair[comb[0]];
					let end = pair[comb[1]];
					let curr = start.edge;
					while(curr.next != null)
					{
						if((curr != start.edge) && (curr.twin.next.twin.next != curr))
						{
							console.error("not a line!")
						}
						curr = curr.next;
					}
					if(curr.twin.origin != end)
					{
						console.error("Did not reach end through chain!")
					}
				}
			}

			//Clear duplicates endings
			for(let i = 0; i < pairs.length; i++)
			{
				for(let j = i+1; j < pairs.length; j++)
				{
					for(let comb of [[0,0],[0,1],[1,0],[1,1]])
					{
						let end1 = pairs[i][comb[0]];
						let end2 = pairs[j][comb[1]];
						if((end1.x == end2.x) && (end1.y == end2.y))
						{
							//console.log("Duplicate endings x %f y %f", end1.x, end1.y);
							//console.log("ends\n", end1, end2);
							let e1 = end1.edge;
							let e2 = end2.edge;

							e1.prev = e2.twin;
							e2.twin.next = e1;

							e2.prev = e1.twin;
							e1.twin.next = e2;

							e2.origin = e1.origin;
							end2.edge = null;
							let secondOther = (comb[1] == 1 ? 0 : 1);
							pairs[i][comb[0]] = pairs[j][secondOther];
							pairs.splice(j, 1);
							j = i+1;
							break;
						}
					}
				}
			}

			return [vertices, edges, pairs];
		}

		$("#submitFreeInput").click(function()
		{
			clearCanvas(c1);

			overlayMap();
		});

	</script>
</html>
